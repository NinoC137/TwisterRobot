# 物联方式

## WiFi



## 蓝牙

> * 设备开机后建立BLE服务
>
> * 特征码：
>
>   |                        |                                      |                               |
>   | :--------------------- | ------------------------------------ | ----------------------------- |
>   | SERVICE_UUID           | ab1ad444-6724-11e9-a923-1681be663d3e |                               |
>   | CHARACTERISTIC_UUID_RX | ab1ad980-6724-11e9-a923-1681be663d3e | 写服务，接受app写入的数据     |
>   | CHARACTERISTIC_UUID_TX | ab1adb06-6724-11e9-a923-1681be663d3e | 通知，读取服务，返回数据给app |

## 数据格式

> * 统一使用JSON格式发送消息、返回结果
>
> * 发送消息：
>
>   ```json
>   {
>       "cmd": 1,
>       "strArg": "str1",
>       "intArg": 123
>   }
>   ```
>
> * 返回结果：
>
>   ```json
>   {
>       "res": 0,
>       "cmd": 1
>   }
>   ```
>
>   * res：成功返回0,非0表示失败

# 指令集

## 扫描Wifi列表(可扫描3~5个wifi)

> * 指令：
>
>   ```json
>   {
>       "cmd": 1
>   }
>   ```
>
> * 返回结果：
>
>   ```json
>   {
>       "res": 0,
>       "cmd": 1,
>       "wifi" [
>       	{
>       		"ssid": "ssid1",
>       		"enc": 0,
>       		"rssi": 59
>   		},
>   		{
>               "ssid": "ssid2",
>       		"enc": 0,
>       		"rssi": 78
>           },
>   		...
>       ]
>   }
>   ```
>
>   ssid: wifi名称
>
>   enc: 是否加密
>
>   rssi：信号强度

## 设置Wifi(设备回电后,仅连接idx为0的wifi)

> * 指令：
>
>   ```json
>   {
>       "cmd": 2,
>       "idx": 0,
>       "ssid": "ssid1",
>       "psw": "12345678"
>   }
>   ```
>
>   idx: Wifi索引。设备最多可以保存5个Wifi连接，通过索引进行管理
>
>   ssid：Wifi名称。ssid为空字符串（""）时表示删除设置
>
>   psw：Wifi连接密码。没有设置时为空字符串（""）
>
> * 返回结果：
>
>   ```json
>   {
>       "res": 0,
>       "cmd": 2
>   }
>   ```
>
>   **设置Wifi后，要进行连接尝试**
>
>   **设备回电后，要对保存的Wifi设置进行连接**

## 读取设备保存的Wifi设置(仅保存一个wifi)

> * 指令：
>
>   ```json
>   {
>       "cmd": 3
>   }
>   ```
>
> 
>
> * 返回结果：
>
>   ```json
>   {
>       "res": 0,
>       "cmd": 3，
>       "wifi": [
>       	{
>       		"idx": 0,
>       		"ssid": "ssid1",
>       		"psw": "12345678"
>   		},
>   		{
>       		"idx": 1,
>       		"ssid": "ssid2",
>       		"psw": "12345678"
>           },
>   		{
>       		"idx": 2,
>       		"ssid": "ssid3",
>       		"psw": "12345678"
>           }
>       ]
>   }
>   ```
>
> 

## 启/停设备

> * 指令：
>
>   ```json
>   {
>       "cmd": 4,
>       "switch": 1,
>       "worktime": 300,
>   }
>   ```
>
>  switch：启/停标识。1——启动；0——停止
>
>  worktime：工作时长。单位：秒
>
>  new_crc：设备校验密钥
>
> * 返回结果：
>
>  ```json
>  {
>      "res": 0,
>      "cmd": 4
>  }
>  ```

## 设置时间

> * 指令：
>
>   ```json
>   {
>       "cmd": 5,
>       "year": 23,
>       "month": 10,
>       "day": 1,
>       "hour": 12,
>       "minute": 0,
>       "second": 0
>   }
>   ```
>
> 
>
> * 返回结果：
>
>   ```json
>   {
>       "res": 0,
>       "cmd": 5
>   }
>   ```

## 设置时区

> * 指令：
>
>   ```json
>   {
>       "cmd": 6,
>       "timezone": 8
>   }
>   ```
>
> 
>
> * 返回结果：
>
>   ```json
>   {
>       "res": 0,
>       "cmd": 6
>   }
>   ```

## 查询时区

> * 指令：
>
>   ```json
>   {
>       "cmd": 7
>   }
>   ```
>
> 
>
> * 返回结果：
>
>   ```json
>   {
>       "res": 0,
>       "cmd": 7,
>       "timezone": 8
>   }
>   ```

## 查询设备信息

> * 指令：
>
>   ```json
>   {
>       "cmd": 8
>   }
>   ```
>
> 
>
> * 返回结果：
>
>   ```json
>   {
>       "res": 0,
>       "cmd": 8,
>       "staMAC": "29:AE:B4:86:CA:C6",
>       "staIP": "192.168.31.200",
>       "devID": "29AEB486CAC6",
>       "devType": "esp32"
>   }
>   ```
>
> 
>
>     staMAC：固件MAC地址（Wifi）
>     
>     staIP：设备连接Wifi后的IPv4地址
>     
>     devID：设备固定标识，一般取staMAC转换成的字符串
>     
>     devType：设备分代标识
>     
>     version：固件版本号

## 设置设备工作时长

> * 指令：
>
>   ```json
>   {
>       "cmd": 9,
>       "worktime": 1800，
>       "speed": 80,
>       "temp": 60
>   }
>   ```
>
>   worktime：工作时长，单位：秒
>
>   speed：初始转速，单位：百转/分钟
>
>   temp：初始温度，单位：℃
>
> * 返回结果：
>
>   ```json
>   {
>       "res": 0,
>       "cmd": 9
>   }
>   ```

## 查询设备剩余时长

> * 指令：
>
>   ```json
>   {
>       "cmd": 10
>   }
>   ```
>
> 
>
> * 返回结果：
>
>   ```json
>   {
>       "res": 0,
>       "cmd": 10,
>       "worktime": 1800,
>       "runtime": 1440，
>       "speed": 80,
>       "temp": 60
>   }
>   ```
>
>   worktime：最后设置工作时长。单位：秒
>
>   runtime：设备本次已运行时长。单位：秒
>
>   speed：当前转速，单位：百转/分钟
>
>   temp：当前温度，单位：℃

## 服务器设置

> * 指令：
>
>   ```json
>   {
>       "cmd": 12,
>       "serverip": "iot.lyhctech.com",
>       "serverport" 6588
>   }
>   ```
>
>   serverip：服务器域名或IP地址
>
>   serverport：服务器监听端口
>
> * 返回结果：
>
>   ```json
>   {
>       "res": 0,
>       "cmd": 12
>   }
>   ```

## 读取服务器设置

> * 指令：
>
>   ```json
>   {
>       "cmd": 13
>   }
>   ```
>
> 
>
> * 返回结果：
>
>   ```json
>   {
>       "res": 0,
>       "cmd": 13,
>       "serverip": "iot.lyhctech.com",
>       "serverport" 6588
>   }
>   ```

## 心跳包设置

> * 指令：
>
>   ```json
>   {
>       "cmd": 14,
>       "keepalivetime": 100,
>       "keepalivecnt" 3
>   }
>   ```
>
> 
>
> * 返回结果：
>
>   ```json
>   {
>       "res": 0,
>       "cmd": 14
>   }
>   ```

## 读取心跳包设置

> * 指令：
>
>   ```json
>   {
>       "cmd": 15
>   }
>   ```
>
> * 返回结果：
>
>   ```json
>   {
>       "res": 0,
>       "cmd": 15,
>       "keepalivetime": 100,
>       "keepalivecnt" 3
>   }
>   ```

## 初始设备信息

> * 指令：
>
>   ```json
>   {
>       "cmd": 19,
>       "devName": "NSRS000001"    
>   }
>   ```
>
>   devName：设备名称。持久保存，如果已经存在，返回错误
>
> * 返回结果：
>
>   ```json
>   {
>       "res": 0,
>       "cmd": 19
>   }
>   ```

# 事件日志(时间戳部分需联网方可进行世界时间记录,否则仅进行设备运行时间记录)

> * 设备接收到相应指令或状态发生变化时，会分别通过蓝牙和Wifi向宿主机/服务器发送日志
>
> * 设备也会定时隔一段时间，分别通过蓝牙和Wifi向宿主机/服务器发送日志（心跳包）
>
> * 日志内容：
>
>   ```json
>   {
>       "cmd": 16/17,
>       "device_id": "xxxxxxx",
>       "blestatus": 1,
>       "wifistatus": 1,
>       "switch": 1，
>       "speed": 80,
>       "temp": 60,
>       "time": "2023-10-01 12:00:00"
>   }
>   ```
>
>   cmd：事件类型。16——通过Wifi向服务器发送；17——通过蓝牙向宿主机发送
>
>   device_id：设备ID，一般为设备Mac地址（Wifi）组成的字符串
>
>   blestatus：蓝牙连接状态。0——未连接；1——已连接
>
>   wifistatus：Wifi连接状态。0——未连接；1——已连接
>
>   switch：设备启动状态。0——未启动；1——正在运行
>
>   speed：初始转速，单位：百转/分钟
>
>   temp：初始温度，单位：℃
>
>   time：设备时间
>
> * 宿主机/服务器返回结果：
>
>   ```json
>   {
>       "res": "ok",
>       "cmd": 16/17
>   }
>   ```
>
> 
